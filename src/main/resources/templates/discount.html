<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Steam 할인 게임 목록</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/nav.css}">
    <link rel="stylesheet" th:href="@{/css/discount.css}">
</head>

<body>
    <div th:replace="~{nav :: global-nav}"></div>
    <h1>Steam 할인 게임 목록</h1>
    <table>
        <thead>
            <tr>
                <th>게임 이름</th>
                <th>할인율</th>
                <th>원가</th>
                <th>할인가</th>
            </tr>
        </thead>
        <tbody id="gamesList">
            <tr th:each="game : ${games}">
                <td>
                    <div class="game-name-container">
                        <a th:href="${game.steamUrl}" target="_blank"> <!-- 링크 추가 -->
                            <img th:src="${game.imageUrl}" alt="게임 이미지" class="game-image">
                            <span th:text="${game.name}"></span>
                        </a>
                    </div>
                </td>
                <td class="discount" th:text="${game.discountPercent + '%'}"></td>
                <td th:text="${'￦' + #numbers.formatDecimal(game.originalPrice, 0, 'COMMA', 0, 'POINT')}"></td>
                <td th:text="${'￦' + #numbers.formatDecimal(game.finalPrice, 0, 'COMMA', 0, 'POINT')}"></td>
            </tr>
        </tbody>
    </table>
    <div id="loading" style="display:none;">
        <div class="spinner"></div>
        <p>게임을 더 불러오는 중...</p>
    </div>
    <button id="loadMoreBtn" th:if="${hasMore}">더 보기</button>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:inline="javascript">
        let page = 0;
        const size = 10;
        let hasMore = /*[[${hasMore}]]*/ false;

        $(document).ready(function () {
            if (hasMore) {
                $('#loadMoreBtn').click(loadMoreGames);
            } else {
                $('#loadMoreBtn').hide();
            }
        });

        function loadMoreGames() {
            $('#loading').show();
            $('#loadMoreBtn').prop('disabled', true);

            $.ajax({
                url: '/api/games',
                data: { page: page, size: size },
                dataType: 'json',
                success: function (response) {
                    if (response.games && response.games.length > 0) {
                        appendGames(response.games);
                        page++;
                        hasMore = response.hasMore;
                        if (!hasMore) {
                            $('#loadMoreBtn').hide();
                        }
                    } else {
                        $('#loadMoreBtn').hide();
                        $('#gamesList').append('<tr><td colspan="4">더 이상 표시할 게임이 없습니다.</td></tr>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX 오류:", status, error);
                    $('#gamesList').append('<tr><td colspan="4">게임 로딩 중 오류가 발생했습니다. 페이지를 새로고침하거나 나중에 다시 시도해 주세요.</td></tr>');
                },
                complete: function () {
                    $('#loading').hide();
                    $('#loadMoreBtn').prop('disabled', false);
                }
            });
        }

        function appendGames(games) {
            const tbody = document.getElementById('gamesList');
            games.forEach(function (game) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="game-name-container">
                            <a href="${game.steamUrl}" target="_blank"> <!-- 링크 추가 -->
                                <img src="${game.imageUrl}" alt="${game.name} 게임 이미지" class="game-image" loading="lazy">
                                <span>${game.name}</span>
                            </a>
                        </div>
                    </td>
                    <td class="discount">${game.discountPercent}%</td>
                    <td>￦${Math.floor(game.originalPrice).toLocaleString()}</td>
                    <td>￦${Math.floor(game.finalPrice).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }
    </script>
</body>

</html>