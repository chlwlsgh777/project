<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>커뮤니티</title>

	<!-- CSS 파일 링크 -->
	<link rel="stylesheet" th:href="@{/css/community.css}">
	<link rel="stylesheet" th:href="@{/css/main.css}">
	<link rel="stylesheet" th:href="@{/css/nav.css}">
</head>

<body>
	<!-- 네비게이션 바 -->
	<div th:replace="~{nav :: global-nav}"></div>

	<div class="community-layout">
		<div class="community-header">
			<div class="community-title" onclick="replace()">커뮤니티</div>
			<div class="community-comment">
				게임채널에 함께할 구성원을 모집하거나 자유롭게 의견을 나누는 공간입니다.
			</div>
			<div class="community-category">
				<a th:href="@{/community(category='전체', page=0)}" th:class="${category == '전체' ? 'active' : ''}">전체</a>
				<a th:href="@{/community(category='자유', page=0)}" th:class="${category == '자유' ? 'active' : ''}">자유</a>
				<a th:href="@{/community(category='모집', page=0)}" th:class="${category == '모집' ? 'active' : ''}">모집</a>
				<a th:href="@{/community(category='후기', page=0)}" th:class="${category == '후기' ? 'active' : ''}">후기</a>
				<a th:href="@{/community(category='공략', page=0)}" th:class="${category == '공략' ? 'active' : ''}">공략</a>
			</div>
		</div>

		<div class="comments-wrap">
			<div class="community-add-area">
				<p class="community-title2">게시판</p>
				<span class="add-post-btn" onclick="checkLoginBeforeWrite()">글쓰기</span>
			</div>

			<!-- 게시글 테이블 -->
			<table class="community-e-header">
				<thead>
					<tr>
						<th>번호</th>
						<th>카테고리</th>
						<th>제목</th>
						<th>작성자</th>
						<th>작성날짜</th>
						<th>조회수</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="community : ${communities}">
						<td th:text="${community.id}"></td>
						<td th:text="${community.category}"></td>
						<td>
							<a th:href="@{/community/{id}(id=${community.id})}" th:text="${community.title}"></a>
						</td>
						<td th:text="${community.author.nickname}"></td>
						<td th:text="${#temporals.format(community.date, 'MM-dd')}"></td>
						<td th:text="${community.viewCount != null ? community.viewCount : 0}"></td>
					</tr>
				</tbody>
			</table>

			<div class="community-footer">
				<!-- 검색 폼 -->
				<form class="community-search-bar" th:action="@{/community}" method="get">
					<input type="text" name="search" th:value="${search}" placeholder="게시글 검색"
						class="community-search-input" aria-label="게시글 검색" />
					<input type="hidden" name="page" value="0" />
					<input type="hidden" name="category" th:value="${category}" />
					<button type="submit">검색</button>
				</form>

				<!-- 페이지네이션 -->
				<div class="pagination-box">
					<span th:if="${currentPage > 0}">
						<a
							th:href="@{/community(page=${currentPage - 1}, search=${search}, category=${category})}">이전</a>
					</span>
					<span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
						<a th:href="@{/community(page=${i}, search=${search}, category=${category})}" th:text="${i + 1}"
							th:class="${i == currentPage ? 'active' : ''}"></a>
					</span>
					<span th:if="${currentPage < totalPages - 1}">
						<a
							th:href="@{/community(page=${currentPage + 1}, search=${search}, category=${category})}">다음</a>
					</span>
				</div>
			</div>
		</div>
	</div>

	<script th:inline="javascript">
		function checkLoginBeforeWrite() {
			// 현재 페이지 URL 저장
			sessionStorage.setItem('communityReturnUrl', window.location.href);

			fetch('/api/check-login')
				.then(response => response.json())
				.then(data => {
					if (data.isLoggedIn) {
						window.location.href = '/community/write';
					} else {
						alert('로그인 후 이용해주세요.');
						window.location.href = '/login?redirect=/community/write';
					}
				});
		}

		function replace() {
			window.location.href = '/community';
		}

		document.addEventListener('DOMContentLoaded', function () {
			const urlParams = new URLSearchParams(window.location.search);
			const category = urlParams.get('category') || '전체';
			const activeLink = document.querySelector(`.community-category a[href*="category=${category}"]`);
			if (activeLink) {
				activeLink.classList.add('active');
			}
		});
	</script>
</body>

</html>