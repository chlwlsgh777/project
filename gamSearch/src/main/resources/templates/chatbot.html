<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>쳇봇</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/nav.css}">
    <link rel="stylesheet" th:href="@{/css/chatbot.css}">
</head>
<body>
    <div th:replace="~{nav :: global-nav}"></div>
    
    <main class="main-content">
        <h1>채팅봇</h1>
        <div id="chat-wrapper">
            <div id="chat-container">
                <div id="chat-messages"></div>
                <div id="user-input">
                    <input type="text" id="message-input" placeholder="메시지를 입력하세요..." style="background-color:#666; color:white;">
                    <button onclick="sendMessage()">전송</button>
                </div>
            </div>
        </div>
    </main>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {

            $('#message-input').keypress(function (event) {
                if (event.which === 13) { // 13은 엔터 키의 keyCode입니다.
                    event.preventDefault(); // 기본 제출 동작 방지
                    sendMessage();
                }
            });

            $.ajax({
                url: '/chat',
                method: 'POST',
                data: { userInput: 'start' },
                success: function (data) {
                    console.log("Received data:", data);  // 디버깅을 위한 로그
                    addMessage('bot', data);
                },
                error: function (error) {
                    console.error('Error:', error);
                    addMessage('bot', { message: '오류가 발생했습니다.', games: [] });
                }
            });
        });

        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (message) {
                addMessage('user', message);
                $.ajax({
                    url: '/chat',
                    method: 'POST',
                    data: { userInput: message },
                    success: function (data) {
                        console.log("Received data:", data);
                        addMessage('bot', data);
                    },
                    error: function (error) {
                        console.error('Error:', error);
                        addMessage('bot', { message: '오류가 발생했습니다.', games: [] });
                    }
                });

                input.value = '';
                input.focus();
            }
        }

        function createGameBox(game) {
            if (!game || typeof game !== 'object') {
                console.warn("Invalid game info received, skipping box creation.");
                return null;
            }

            const gameBox = document.createElement('div');
            gameBox.className = 'game-box';

            const title = document.createElement('h3');
            const titleLink = document.createElement('a');
            titleLink.href = `https://store.steampowered.com/app/${game.app_id}`;
            titleLink.textContent = game.name || '이름 없음';
            titleLink.target = '_blank'; // 새 탭에서 링크 열기
            titleLink.rel = 'noopener noreferrer'; // 보안 개선
            title.appendChild(titleLink);
            gameBox.appendChild(title);

            const details = document.createElement('p');
            details.innerHTML = `
            <strong>앱 ID:</strong> ${game.app_id || 'N/A'}<br>
            <strong>출시일:</strong> ${game.release_date || 'N/A'}<br>
            <strong>장르:</strong> ${game.genres || 'N/A'}<br>
            <strong>태그:</strong> ${game.tags || 'N/A'}
        `;
            gameBox.appendChild(details);

            return gameBox;
        }



        function addMessage(sender, data) {
            console.log("Adding message:", sender, data);
            const messagesContainer = document.getElementById('chat-messages');

            if (sender === 'bot') {
                // 게임 목록 표시
                if (data.games && Array.isArray(data.games) && data.games.length > 0) {
                    data.games.forEach(game => {
                        const gameBox = createGameBox(game);
                        if (gameBox) {
                            messagesContainer.appendChild(gameBox);
                        }
                    });
                }

                // 메시지 표시
                if (data.message) {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message bot-message';
                    messageElement.innerHTML = data.message.replace(/\n/g, '<br>');
                    messagesContainer.appendChild(messageElement);
                }
            } else {
                const messageElement = document.createElement('div');
                messageElement.className = 'message user-message';
                messageElement.textContent = data;
                messagesContainer.appendChild(messageElement);
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }




    </script>
</body>
</html>